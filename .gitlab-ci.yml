stages:
  - test
  - build
  - deploy

variables:
  DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  INFRA_REPO: "https://oauth2:${INFRA_REPO_TOKEN}@gitlab.com/${INFRA_REPO_PATH}.git"
  INFRA_REPO_PATH: "adrianrigo/sem4_work"

unit-test-job:
  stage: test
  image: python:3.10
  before_script:
    - pip install -r requirements.txt
    - pip install pytest
  script:
    - echo "Running unit tests..."
    - python -m pytest
  only:
    - branches

build-job:
  image: docker:cli
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    # Build and push with commit SHA
    - docker build -f Dockerfile.prod --pull -t "$DOCKER_IMAGE_NAME" .
    - docker push "$DOCKER_IMAGE_NAME"
    
    # Tag and push as latest for main branch
    - |
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        docker tag "$DOCKER_IMAGE_NAME" "$CI_REGISTRY_IMAGE:latest"
        docker push "$CI_REGISTRY_IMAGE:latest"
      fi
  only:
    - branches

update-helm-values:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache git yq
  script:
    - echo "Updating Helm values in sem4_work repository..."
    
    # Clone infrastructure repository
    - git clone $INFRA_REPO infra-repo
    - cd infra-repo
    
    # Configure git
    - git config user.email "ci@gitlab.com"
    - git config user.name "GitLab CI"
    
    # Update image tag in Helm values
    - |
      yq eval ".image.tag = \"$CI_COMMIT_SHORT_SHA\"" -i helm/tournament-generator/values-prod.yaml
      
    # Commit and push changes
    - git add helm/tournament-generator/values-prod.yaml
    - git commit -m "Update image tag to $CI_COMMIT_SHORT_SHA [skip ci]" || echo "No changes to commit"
    - git push origin main
    
    - echo "✅ Updated sem4_work repository. ArgoCD will sync automatically."
  only:
    - main
  when: manual

update-kustomize:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl
    # Install kustomize
    - curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
    - mv kustomize /usr/local/bin/
  script:
    - echo "Updating Kustomize in sem4_work repository..."
    
    # Clone infrastructure repository
    - git clone $INFRA_REPO infra-repo
    - cd infra-repo
    
    # Configure git
    - git config user.email "ci@gitlab.com"
    - git config user.name "GitLab CI"
    
    # Update image tag in kustomization
    - cd kustomize/overlays/production
    - kustomize edit set image generator-api=$DOCKER_IMAGE_NAME
    
    # Commit and push changes
    - git add kustomization.yaml
    - git commit -m "Update image to $DOCKER_IMAGE_NAME [skip ci]" || echo "No changes to commit"
    - git push origin main
    
    - echo "✅ Updated sem4_work repository. ArgoCD will sync automatically."
  only:
    - main
  when: manual